<%- include('partials/header') %>
<div class="container">
  <div class="flex flex-between flex-center mb-2">
    <h1 style="color: #f1f5f9;">Dashboard</h1>
    <span class="badge badge-<%= user.plan || 'free' %>" style="font-size: 0.9rem; padding: 0.4rem 1rem;"><%= (user.plan || 'free').toUpperCase() %> Plan</span>
  </div>

  <% if (typeof message !== 'undefined' && message) { %>
    <div class="alert alert-info"><%= message %></div>
  <% } %>

  <div class="grid-4 mb-2">
    <div class="stat-card">
      <div class="stat-value"><%= apiKeys.length %></div>
      <div class="stat-label">API Keys</div>
    </div>
    <div class="stat-card">
      <div class="stat-value"><%= parseInt(usage.total || 0).toLocaleString() %></div>
      <div class="stat-label">Total Lookups</div>
    </div>
    <div class="stat-card">
      <div class="stat-value"><%= parseInt(usage.today || 0).toLocaleString() %></div>
      <div class="stat-label">Lookups Hari Ini</div>
    </div>
    <div class="stat-card">
      <div class="stat-value"><%= user.plan === 'vip' ? '10,000' : user.plan === 'premium' ? '1,000' : '100' %></div>
      <div class="stat-label">Daily Limit</div>
    </div>
  </div>

  <div class="grid-2">
    <div>
      <div class="card">
        <div class="flex flex-between flex-center mb-1">
          <h3>API Keys</h3>
          <form method="POST" action="/dashboard/generate-key" style="display: flex; gap: 0.5rem;">
            <input type="text" name="name" placeholder="Nama key" style="padding: 0.4rem 0.8rem; background: #0f172a; border: 1px solid #334155; border-radius: 6px; color: #e2e8f0; width: 130px;">
            <button type="submit" class="btn btn-success btn-sm">Generate Key</button>
          </form>
        </div>
        <% if (apiKeys.length === 0) { %>
          <p class="text-muted text-sm">Belum ada API key. Generate key pertama Anda.</p>
        <% } else { %>
          <% apiKeys.forEach(function(key) { %>
            <div style="background: #0f172a; border: 1px solid #334155; border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem;">
              <div class="flex flex-between flex-center">
                <div>
                  <strong style="color: #f1f5f9;"><%= key.name %></strong>
                  <span class="badge <%= key.is_active ? 'badge-active' : 'badge-inactive' %>" style="margin-left: 0.5rem;"><%= key.is_active ? 'Active' : 'Inactive' %></span>
                </div>
                <div style="display: flex; gap: 0.3rem;">
                  <form method="POST" action="/dashboard/toggle-key/<%= key.id %>">
                    <button type="submit" class="btn btn-warning btn-sm"><%= key.is_active ? 'Disable' : 'Enable' %></button>
                  </form>
                  <form method="POST" action="/dashboard/delete-key/<%= key.id %>" onsubmit="return confirm('Hapus API key ini?')">
                    <button type="submit" class="btn btn-danger btn-sm">Hapus</button>
                  </form>
                </div>
              </div>
              <div class="code-block mt-1" style="font-size: 0.75rem; word-break: break-all;"><%= key.api_key %></div>
              <div class="text-sm text-muted mt-1">
                Requests: <%= key.requests_total %> total | <%= key.requests_today %> hari ini
                <% if (key.last_used_at) { %> | Terakhir: <%= new Date(key.last_used_at).toLocaleString('id-ID') %><% } %>
              </div>
            </div>
          <% }); %>
        <% } %>
      </div>
    </div>

    <div>
      <div class="card">
        <h3 class="mb-1">Quick MSISDN Lookup</h3>
        <form method="POST" action="/msisdn-lookup" style="display: flex; gap: 0.5rem;">
          <input type="text" name="msisdn" placeholder="Contoh: 08123456789" required style="flex: 1; padding: 0.6rem; background: #0f172a; border: 1px solid #334155; border-radius: 6px; color: #e2e8f0;">
          <button type="submit" class="btn btn-primary">Lookup</button>
        </form>
      </div>

      <div class="card">
        <h3 class="mb-1">Riwayat Lookup Terakhir</h3>
        <% if (recentLookups.length === 0) { %>
          <p class="text-muted text-sm">Belum ada riwayat lookup.</p>
        <% } else { %>
          <table>
            <thead><tr><th>MSISDN</th><th>Operator</th><th>Waktu</th></tr></thead>
            <tbody>
              <% recentLookups.forEach(function(l) { %>
                <tr>
                  <td><%= l.msisdn %></td>
                  <td><%= l.operator_name %></td>
                  <td><%= new Date(l.created_at).toLocaleString('id-ID') %></td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        <% } %>
      </div>

      <div class="card">
        <h3 class="mb-1">API Usage Example</h3>
        <div class="code-block">curl -H "X-API-Key: YOUR_API_KEY" \
  "<%= typeof process !== 'undefined' ? '' : '' %>/api/v1/msisdn/08123456789"</div>
      </div>
    </div>
  </div>
</div>
<%- include('partials/footer') %>
